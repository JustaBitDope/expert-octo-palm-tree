<!DOCTYPE HTML>
<html>

<head lang="en-US">
	<title>Browse</title>
</head>

<body>

	<h1 style= "text-align: center">Come do Some Browse brah</h1>
	<p style= "text-align: center">Waddup yo. We got some good shit for you to browse right here.</p>
	
	<p id="checker" ></p>
	
	<p id="output" ></p>
	<div>
		<label>Search</label>
		<input type="text" id="searchBar">
		<button onclick="searchAuction()"> Search </button>
		<p>
			Search will return all results whose description or name contain the search term
		</p>
	</div>
	<div>
		<label id="searchResults"></label>
		<br>
		<table id="allAuctions">
			<thead id="tableHead"></thead>
			<tbody id="tableBody"></tbody>
		</table>
	</div>
</body>

<footer>
   	<!-- import jQuery -->
   	<script src="../js/jquery-1.11.2.min.js"></script> 
	 
	<!-- $(document).ready -->
	<script>
		// Runs when the page has loaded
		$(document).ready(function() {
			reset();
		});
	</script>
	<!-- -->

	<!-- displayAllAuctions(auctions) -->
	<script>
		// Displays all auctions on the page
		function displayAllAuctions(auctions){
			console.log("SUCC!");
			console.log(auctions);
			$("#checker").text("Success! Apparently...");
			$("#output").text(auctions);
			
			var body = document.getElementById("tableBody");
			var newBody = document.createElement('tbody');
			newBody.id = "tableBody";
			body.parentNode.replaceChild(newBody, body);
			
			var head = document.getElementById("tableHead");
			var newHead = document.createElement('thead');
			newHead.id = "tableHead";
			head.parentNode.replaceChild(newHead, head);
			
			if(auctions.length==0){
				newBody
			}
			
			for(var i=0; i!=auctions.length; i++) {
				var auction = auctions[i];
				displayAuction(auction);
			}
			
			var header = document.getElementById("tableHead");
			var row = header.insertRow(0);
			
			var nameCol = row.appendChild(document.createElement("th"));
			nameCol.appendChild(document.createTextNode("Name"));
			
			var descCol = row.appendChild(document.createElement("th"));
			descCol.appendChild(document.createTextNode("Description"));
			
			var catCol = row.appendChild(document.createElement("th"));
			catCol.appendChild(document.createTextNode("Category"));
			
			var startCol = row.appendChild(document.createElement("th"));
			startCol.appendChild(document.createTextNode("Start Date"));
			
			var endCol = row.appendChild(document.createElement("th"));
			endCol.appendChild(document.createTextNode("End Date"));
			
			var viewCol = row.appendChild(document.createElement("th"));
			viewCol.appendChild(document.createTextNode(""));

			$("#allAuctions").show();
		}
	</script>
	
	<!-- displayAuction(auction) -->
   	<script>
   		function displayAuction(auction){
			console.log(auction);
			var item = auction.item;	
			
			//The Table we will being appending to
			var tbody = document.getElementById("tableBody");
			
			//The Data to put into the table
			var name = document.createTextNode(item.name);
			var desc = document.createTextNode(item.description);
			var cat  = document.createTextNode(item.category.name);
			
			var start = new Date(auction.startDate.epochSecond * 1000);
			var end = new Date(auction.endDate.epochSecond * 1000);  			

			var startDay = start.getDate();
			var endDay = end.getDate();
			var startMonth = start.getMonth() + 1;		//0 = Jan
			var endMonth = end.getMonth() + 1;			//0 = Jan
			console.log(startDay > 10);
			if(10 > startDay)startDay = "0"+startDay;
			if(10 > endDay)endDay = "0"+endDay;
			if(10 > startMonth)startMonth = "0"+startMonth;
			if(10 > endMonth)endMonth = "0"+endMonth;

			
			var startFormat = document.createTextNode(startDay + '/' + startMonth + '/' + start.getFullYear());
			var endFormat = document.createTextNode(endDay + '/' + endMonth + '/' + end.getFullYear());
			
			//Add Button to view specific Auction 
			var viewAuctBtn = document.createElement('button');
			//Button is assigned id of relevant auction
			viewAuctBtn.id = auction.id;
			viewAuctBtn.innerHTML = "View Auction Page";
			viewAuctBtn.onclick = function(){viewAuction(this);}
			
			//Create cells to fill
			var row = tbody.insertRow(-1);
			var nameCol = row.insertCell(-1);
			var descCol = row.insertCell(-1);
			var catCol = row.insertCell(-1);
			var startCol = row.insertCell(-1);
			var endCol = row.insertCell(-1);
			var viewCol = row.insertCell(-1);
			
			//Fill Cells
			nameCol.appendChild(name);
			descCol.appendChild(desc);
			catCol.appendChild(cat);
			startCol.appendChild(startFormat);
			endCol.appendChild(endFormat);
			viewCol.appendChild(viewAuctBtn);
   		}
   	</script>
	

	<!-- viewAuction(btnClicked) -->
	<script>
    		function viewAuction(btnClicked){
    			var auctionID = btnClicked.id;
    			console.log("Selected Auction: "+auctionID);
    			window.location.href = "/viewAuction?id="+auctionID;
    		}
  </script>
  	
  	<!-- search Auction-->
  	<script>
  		function searchAuction(){
  			var search = $("#searchBar").val();
  			if(search.length==0){
  				reset();
  			}
  			else{
  	  			$.ajax({
  	  				type: "POST",
  	  				contentType: "text/plain",
  					data:search,
  					url: "/auth/auction/search",
  					success: function(results){
  						console.log(results);
  						if(results.length==0){
  							document.getElementById("searchResults").innerHTML = "No Results found";
  							$("#allAuctions").hide();
  						}
  						else{
  							document.getElementById("searchResults").innerHTML = "Auction names that contain your search";
  							displayAllAuctions(results);
  						}
  					},
  					error: function(){
  						
  					}
  	  			});  				
  			}
  		}
  	</script>
  	
  	<!-- Resets the page to show all auctions -->
  	<script>
  		function reset(){
  		  	$.ajax({
  				type: "GET",
  				datatype: "json",
  				url: "/auth/auction/all",
  				success: function(all_auctions) {
  					console.log("win! wooo!");
  					console.log(all_auctions);
  					displayAllAuctions(all_auctions);
  				document.getElementById("searchResults").innerHTML = "";
  				},
  				error: function() {
  					console.log("Error yo");
  					$("#checker").text("error. balls.");
  					$("#output").text("Summat broke");
  				}
  			});  			
  		}
  	</script>
</footer>

</html>