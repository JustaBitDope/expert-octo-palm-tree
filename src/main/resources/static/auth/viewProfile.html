<!DOCTYPE HTML>
<html lang="en-US">
    <head>
        <title>View Profile</title>
    </head>
    <body>
    	<div id="loggedIn" style="display : none;">
    		<div id="ProfileDetails">
    			<table>
    			<tr>
    				<td><label id="mode"></label></td>
    			</tr>
    			<tr>
    				<td><label>Real Name :</label></td>
	       			<td><input id="realName" type="text" onkeyup="checkName()"/></td>
	      			<td><label id="hasName" style="color:#FF0000"></label></td>        			
   				</tr>
   				<tr>
    				<td><label>User Name :</label></td>
	       			<td><input type="text" id="userName" onkeyup="checkUserName()"/></td>
	       			<td><label id="UniqueUserName" style="color:#FF0000"></label></td>
   				</tr>
  				<tr>
    				<td><label>Biography :</label></td>
        			<td><input type="text" id="bio"/></td>
   				</tr>
    		</table>
	    		<div id="enableEdit" style="display : none;">
	    			<table>
		   				<tr>
		   					<td><button onclick="editData(true)">Edit Profile</button></td>
		   				</tr>    			
	    			</table>
	    		</div>
	    		<div id="editing" style="display : none;">
	    			<table>
	    				<tr>
	    					<td><button id="saveEdit" onclick="save()">Update Profile</button></td>
							<td><button id="cancelEdit" onclick="window.location.href = '/viewProfile'">Cancel</button></td>
	    				</tr>
	    			</table>
    			</div>
    		</div>
    		<br>
    		<div id="ProfilesAuctions">
    			<table id="myAuctions">    				
    			</table>
    		</div>	
    	</div>
    	<div id="not_loggedIn" style="display : none;">
    		<label>In order to view this page you need to login</label>
    	</div>
    </body>
    <footer>
    	<!-- import jQuery -->
    	<script src="../js/jquery-1.11.2.min.js"></script> 
    
    	<script>
			$(document).ready(function(){
				$.ajax({
					type: "GET",
					datatype: "json",
					url: "/auth/user/current",
					success: function(usr_detail){
						console.log("User Logged in Found");
						console.log(usr_detail.realName);
						constructProfile(usr_detail);
						loadMyAuctions(usr_detail);
					},
					error: function(){
						console.log("No ones logged in");
						document.getElementById("not_loggedIn").style.display = 'block';
					}	
				});
				
			});
        </script>
        
        <!-- Profile Details Section -->
        
        <script>
        	function constructProfile(usr_detail){
        		console.log(usr_detail);

        		document.getElementById("loggedIn").style.display = 'block';
        		document.getElementById("realName").value = usr_detail.realName;
        		document.getElementById("userName").value = usr_detail.user.userName;
        		document.getElementById("bio").value = usr_detail.biography;
        		
        		document.getElementById("enableEdit").style.display = 'block';
        		editData(false);
        	}
        	
        	function editData(state){        		
       			$("#realName").attr("readonly", !state);
       			$("#userName").attr("readonly", !state);
       			$("#bio").attr("readonly", !state);
       			
       			if(!state){
       				document.getElementById("mode").innerHTML = "Read Only";
       			}
       			else{
       				document.getElementById("mode").innerHTML = "Editing Profile";
            		document.getElementById("enableEdit").style.display = 'none';
            		document.getElementById("editing").style.display = 'block';
    			}
        	}
        </script>
        <script>
			function save(){
				$.ajax({
					type: "GET",
					datatype: "json",
					url: "/auth/user/current",
					success: function(usr_detail){
						var user = usr_detail.user;
						
						usr_detail.realName = $("#realName").val();
						usr_detail.biography = $("#bio").val();
						
						user.userName = $("#userName").val();
						
						$.ajax({
							type: "POST",
							contentType: "application/json",
							data: JSON.stringify(usr_detail),
							url: "/auth/details/add",
							success: function(res){
								console.log("Details Updated");
							},
							error: function(){
								console.log("Details not updated");
							}
						});
						
						$.ajax({
							type: "POST",
							contentType: "application/json",
							data: JSON.stringify(user),
							url: "/auth/user/add",
							success: function(res){
								console.log("User Updated");
							},
							error: function(){
								console.log("User not updated");
							}							
						});
						
						console.log(usr_detail.realName);
						constructProfile(usr_detail);
					},
					error: function(){
						console.log("No ones logged in");
						document.getElementById("not_loggedIn").style.display = 'block';
					}	
				});        		
        	}
        </script>
        <script>
		function checkUserName(){
			var userName = document.getElementById("userName").value;
			if(userName == ""){
				document.getElementById("UniqueUserName").innerHTML = "A Username must be provided";
			}
			else{
				$.ajax({
					type: "GET",
					datatype: "json",
					url: "/auth/user/current",
					success: function(usr_detail){
						currentUser = usr_detail.user.userName;
		        		$.ajax({
							type: "POST",
							contentType: "text/plain",
							data:userName,
							url: "/auth/user/username",
							success: function(result){
								console.log(result);
								if(result==""){
									document.getElementById("UniqueUserName").innerHTML = "";
								}
								else if(currentUser == result.userName){
									document.getElementById("UniqueUserName").innerHTML = "";
								}
								else{
			        				document.getElementById("UniqueUserName").innerHTML = "Username taken";
			        			}
							},
							error: function(){
							}
						});					

					},
					error: function(){
					}	
				});	
			}
			disableSubmit();
		}
		
		function checkName(){
			var name = document.getElementById("realName").value;
			if(name == ""){
				document.getElementById("hasName").innerHTML = "A real name must be provided";
			}
			else{
				document.getElementById("hasName").innerHTML = "";
			}
			disableSubmit();
		}
		
		function disableSubmit(){
			var valUser = document.getElementById("UniqueUserName").innerHTML;
			var hasName = document.getElementById("hasName").innerHTML;
			
			if(valUser == "" && hasName == ""){
				document.getElementById("saveEdit").disabled = false;					
			}
			else{
				document.getElementById("saveEdit").disabled = true;					
			}

		}
        </script>
        
        <!-- Auction's Sections -->

    	<script>
    		function loadMyAuctions(usr_detail){
    			$.ajax({
    				type: "POST",
    				contentType: "application/json",
					data: JSON.stringify(usr_detail.user),
    				url: "/auth/auction/user",
    				success: function(auctions){
    					console.log("Found Auctions for Current User");
    					console.log(auctions);
    					
    					for(var i=0; i!=auctions.length;i++){
    						addAuction(auctions[i]);
    					}
    					
    				},
    				error: function(){
    					console.log("Failed to load auctions");
    				}
    			});
    		}
       	</script>
    	<script>
	    	function addAuction(auction){
				console.log(auction);
				var item = auction.item;	
				
				//The Table we will being appending to
				var tbl = document.getElementById("myAuctions");
				
				
				//The Data to put into the table
				var name = document.createTextNode(item.name);
				var desc = document.createTextNode(item.description);
				var cat  = document.createTextNode(item.category.name);
				
				var start = new Date(auction.startDate.epochSecond * 1000);
				var end = new Date(auction.endDate.epochSecond * 1000);  			
				
				var startDay = start.getDate();
				var endDay = end.getDate();
				var startMonth = start.getMonth();
				var endMonth = end.getMonth();
				
				if(startDay<10)startDay = "0"+startDay;
				if(endDay<10)endDay = "0"+endDay;
				if(startMonth<10)startMonth = "0"+startMonth;
				if(endMonth<10)endMonth = "0"+endMonth;
				
				var startFormat = document.createTextNode(startDay + '/' + startMonth + '/' + start.getFullYear());
				var endFormat = document.createTextNode(endDay + '/' + endMonth + '/' + end.getFullYear());
				
				//Add Title data to table
				var row = tbl.insertRow(-1);					
				var col_1 = row.insertCell(-1);
				var col_2 = row.insertCell(-1);
				col_1.appendChild(document.createTextNode("Title: "));
				col_2.appendChild(name);
				
				//Add Desc data
				row = tbl.insertRow(-1);					
				col_1 = row.insertCell(-1);
				col_2 = row.insertCell(-1);
				col_1.appendChild(document.createTextNode("Descritpion: "));
				col_2.appendChild(desc);
				
				//Add Cat data
				row = tbl.insertRow(-1);					
				col_1 = row.insertCell(-1);
				col_2 = row.insertCell(-1);
				col_1.appendChild(document.createTextNode("Category: "));
				col_2.appendChild(cat);
				
				//Add Start Date
				row = tbl.insertRow(-1);					
				col_1 = row.insertCell(-1);
				col_2 = row.insertCell(-1);
				col_1.appendChild(document.createTextNode("Start: "));
				col_2.appendChild(startFormat);
	
				//Add End Date
				row = tbl.insertRow(-1);					
				col_1 = row.insertCell(-1);
				col_2 = row.insertCell(-1);
				col_1.appendChild(document.createTextNode("End: "));
				col_2.appendChild(endFormat);
	
				//Add Button to view specific Auction 
				var viewAuctBtn = document.createElement('button');
				//Button is assigned id of relevant auction
				viewAuctBtn.id = auction.id;
				viewAuctBtn.innerHTML = "View Auction Page";
				viewAuctBtn.onclick = function(){viewAuction(this);}
				
				row = tbl.insertRow(-1);					
				col_1 = row.insertCell(-1);
				col_1.colspan = 2;
				col_1.appendChild(viewAuctBtn);				
			}

    	</script>
    	<script>
    		function viewAuction(btnClicked){
    			var auctionID = btnClicked.id;
    			console.log("Selected Auction: "+auctionID);
    		}
    	</script>
    </footer>    
</html>
